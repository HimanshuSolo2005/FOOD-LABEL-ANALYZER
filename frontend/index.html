<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Ingredient Analyzer</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</head>
<body>
    <div class="container">
        <h1>Food Ingredient Scanner</h1>
        <div class="upload-section">
            <input type="file" id="imageInput" accept="image/*">
            <button id="scanButton">Scan Ingredients</button>
        </div>
        <div class="results-section">
            <div id="loadingIndicator" class="hidden">Scanning...</div>
            <div id="extractedText"></div>
            <div id="harmfulnessResult"></div>
        </div>
    </div>

    <script src="js/ocr.js"></script>
    <script>
        const BACKEND_URL = 'http://localhost:5000/analyze';

        document.getElementById('scanButton').addEventListener('click', async () => {
            const imageFile = document.getElementById('imageInput').files[0];
            if (!imageFile) {
                alert('Please select an image first');
                return;
            }

            try {
                const extractedText = await performOCR(imageFile);

                document.getElementById('extractedText').innerHTML = `
                    <h3>Extracted Ingredients:</h3>
                    <p>${extractedText}</p>
                `;

                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingredients: extractedText })
                });

                const data = await response.json();
                const formatted = formatMarkdownOutput(data.choices ? data.choices[0].message.content : JSON.stringify(data));

                document.getElementById('harmfulnessResult').innerHTML = `
                    <h3>Harmfulness Rating:</h3>
                    <div class="rating">${formatted}</div>
                `;

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('harmfulnessResult').innerHTML = `
                    <div class="error">Error processing image: ${error.message}</div>
                `;
            }
        });

        function formatMarkdownOutput(text) {
            // Convert Markdown-like syntax to styled HTML (basic support)
            return text
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/<li>(.*?)<\/li>/gim, '<ul><li>$1</li></ul>');
        }
    </script>
</body>
</html>
